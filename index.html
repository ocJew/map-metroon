<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <title>Metroon</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css"
    integrity="sha256-sA+zWATbFveLLNqWO2gtiw3HL/lh1giY/Inf1BJ0z14="
    crossorigin=""/>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        .control-buttons {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }
        .control-buttons button {
            background-color: white;
            border: 2px solid #ccc;
            border-radius: 50%;
            padding: 10px;
            margin: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .control-buttons button:hover {
            background-color: #f0f0f0;
        }
        .control-buttons button.active {
            border-color: #666;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="control-buttons">
        <button id="button-sul">Sul</button>
        <button id="button-norte">Norte</button>
        <button id="button-ambos" class="active">Ambos</button>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"
    integrity="sha256-o9N1jGDZrf5tS+Ft4gbIK7mYMipq9lqpVJ91xHSyKhg="
    crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-omnivore@0.3.3/leaflet-omnivore.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-providers/1.13.0/leaflet-providers.min.js"></script>
    <script>
        var map = L.map('map').setView([-3.685, -40.35], 13); // Defina o centro do mapa e o nível de zoom
        // Adicione uma camada de mapa base OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var northLayer = L.layerGroup().addTo(map);
        var southLayer = L.layerGroup().addTo(map);
        var SNLayer = L.layerGroup().addTo(map);

        // Função para adicionar trilhas do arquivo KML
        function addKMLTracks() {
            fetch('./metroon.kml') // Carregue o arquivo KML
            .then(response => response.text())
            .then(kmltext => {
                var parser = new DOMParser();
                var kml = parser.parseFromString(kmltext, 'text/xml');
                
                var northTracks = omnivore.kml.parse(kml, null, L.geoJson(null, {
                    filter: function(feature) {
                        return feature.properties && feature.properties.name && feature.properties.name.includes('Norte');
                    },
                    style: function (feature) {
                        return {
                            color: '#FF0000',
                            weight: 5,
                            opacity: 0.5
                        };
                    },
                    pointToLayer: function (geoJsonPoint, latlng) {
                        return L.marker(latlng, {
                            icon: L.icon({
                                iconUrl: './icons/redball.png',
                                iconSize: [16, 16],
                                iconAnchor: [8, 8],
                            })
                        });
                    }
                }));
                
                var southTracks = omnivore.kml.parse(kml, null, L.geoJson(null, {
                    filter: function(feature) {
                        return feature.properties && feature.properties.name && feature.properties.name.includes('Sul');
                    },
                    style: function (feature) {
                        return {
                            color: '#0000FF',
                            weight: 5,
                            opacity: 0.5
                        };
                    },
                    pointToLayer: function (geoJsonPoint, latlng) {
                        return L.marker(latlng, {
                            icon: L.icon({
                                iconUrl: './icons/blueball.png',
                                iconSize: [16, 16],
                                iconAnchor: [8, 8],
                            })
                        });
                    }
                }));

                northTracks.eachLayer(function(layer) {
                    northLayer.addLayer(layer);
                });

                southTracks.eachLayer(function(layer) {
                    southLayer.addLayer(layer);
                });
            });
        }
        addKMLTracks();

        var redIcon = L.icon({
            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        var blueIcon = L.icon({
            iconUrl: './icons/usuario.png',
            iconSize: [50, 50],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // Adicione a localização do usuário ao mapa
        function addLocationToMap() {
            const urlParams = new URLSearchParams(window.location.search);
            const latParam = urlParams.get('lat');
            const lngParam = urlParams.get('lng');
            if (latParam !== null && lngParam !== null) {
                var userLat = parseFloat(latParam);
                var userLng = parseFloat(lngParam);
                L.marker([userLat, userLng], {icon: redIcon}).addTo(northLayer).bindPopup("VLT NORTE");
            } 
            
            const latParam2 = urlParams.get('lat2');
            const lngParam2 = urlParams.get('lng2');
            if (latParam2 !== null && lngParam2 !== null) {
                var userLat2 = parseFloat(latParam2);
                var userLng2 = parseFloat(lngParam2);
                L.marker([userLat2, userLng2], {icon: redIcon}).addTo(southLayer).bindPopup("VLT SUL");
            } 

            const latParam3 = urlParams.get('lat3');
            const lngParam3 = urlParams.get('lng3');
            if (latParam3 !== null && lngParam3 !== null) {
                var userLat3 = parseFloat(latParam3);
                var userLng3 = parseFloat(lngParam3);
                L.marker([userLat3, userLng3], {icon: blueIcon}).addTo(SNLayer).bindPopup("Sua localização");
            } 
        }
        addLocationToMap();

        function toggleLayer(layer, show) {
            if (show) {
                if (!map.hasLayer(layer)) {
                    map.addLayer(layer);
                }
            } else {
                if (map.hasLayer(layer)) {
                    map.removeLayer(layer);
                }
            }
        }

        document.getElementById('button-sul').addEventListener('click', function() {
            toggleLayer(northLayer, false);
            toggleLayer(southLayer, true);
            setActiveButton('button-sul');
        });

        document.getElementById('button-norte').addEventListener('click', function() {
            toggleLayer(northLayer, true);
            toggleLayer(southLayer, false);
            setActiveButton('button-norte');
        });

        document.getElementById('button-ambos').addEventListener('click', function() {
            toggleLayer(northLayer, true);
            toggleLayer(southLayer, true);
            setActiveButton('button-ambos');
        });

        function setActiveButton(buttonId) {
            document.querySelectorAll('.control-buttons button').forEach(button => {
                button.classList.remove('active');
            });
            document.getElementById(buttonId).classList.add('active');
        }

        // Adicione uma função para mudar o provedor de mapa com base no parâmetro da URL
        function changeMapTheme() {
            const urlParams = new URLSearchParams(window.location.search);
            const theme = urlParams.get('theme');

            if (theme === 'dark') {
                map.eachLayer(function (layer) {
                    if (layer instanceof L.TileLayer && !layer._url.includes('cartodb.dark')) {
                        map.removeLayer(layer);
                    }
                });
                L.tileLayer.provider('CartoDB.DarkMatter').addTo(map);
            } else {
                map.eachLayer(function (layer) {
                    if (layer instanceof L.TileLayer && layer._url.includes('cartodb.dark')) {
                        map.removeLayer(layer);
                    }
                });
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
            }
        }
        // Chame a função para alterar o tema do mapa
        changeMapTheme();


    </script>
</body>
</html>
